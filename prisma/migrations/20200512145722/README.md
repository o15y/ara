# Migration `20200512145722`

This migration has been generated by Anand Chowdhary at 5/12/2020, 2:57:22 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE `ara_v2`.`locations` (
`data` json   ,`id` int NOT NULL  AUTO_INCREMENT,`organizationId` int NOT NULL ,`type` ENUM('IN_PERSON', 'PHONE_CALL', 'VIDEO_CALL') NOT NULL  ,`value` varchar(191) NOT NULL  ,
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `ara_v2`.`meetings` (
`confirmedTime` json   ,`id` int NOT NULL  AUTO_INCREMENT,`locationId` int NOT NULL ,`meetingType` ENUM('IN_PERSON', 'PHONE_CALL', 'VIDEO_CALL') NOT NULL  ,`organizationId` int NOT NULL ,`proposedTimes` json   ,`userId` int NOT NULL ,
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `ara_v2`.`incoming-emails` (
`cc` json NOT NULL  ,`createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ,`emailDate` datetime(3) NOT NULL  ,`from` json NOT NULL  ,`id` int NOT NULL  AUTO_INCREMENT,`inReplyTo` varchar(191)   ,`logs` json   ,`meetingId` int NOT NULL ,`messageId` varchar(191) NOT NULL  ,`objectId` varchar(191) NOT NULL  ,`organizationId` int NOT NULL ,`subject` varchar(191) NOT NULL  ,`to` json NOT NULL  ,`updatedAt` datetime(3) NOT NULL  ,`userId` int NOT NULL ,
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

ALTER TABLE `ara_v2`.`organizations` ADD COLUMN `schedulingDuration` int NOT NULL DEFAULT 30 ,
ALTER COLUMN `schedulingPadding` SET DEFAULT 15;

CREATE UNIQUE INDEX `incoming-emails.objectId` ON `ara_v2`.`incoming-emails`(`objectId`)

CREATE  INDEX `userId` ON `ara_v2`.`incoming-emails`(`userId`)

CREATE  INDEX `organizationId` ON `ara_v2`.`incoming-emails`(`organizationId`)

CREATE  INDEX `meetingId` ON `ara_v2`.`incoming-emails`(`meetingId`)

ALTER TABLE `ara_v2`.`locations` ADD FOREIGN KEY (`organizationId`) REFERENCES `ara_v2`.`organizations`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `ara_v2`.`meetings` ADD FOREIGN KEY (`locationId`) REFERENCES `ara_v2`.`locations`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `ara_v2`.`meetings` ADD FOREIGN KEY (`userId`) REFERENCES `ara_v2`.`users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `ara_v2`.`meetings` ADD FOREIGN KEY (`organizationId`) REFERENCES `ara_v2`.`organizations`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `ara_v2`.`incoming-emails` ADD FOREIGN KEY (`userId`) REFERENCES `ara_v2`.`users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `ara_v2`.`incoming-emails` ADD FOREIGN KEY (`organizationId`) REFERENCES `ara_v2`.`organizations`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `ara_v2`.`incoming-emails` ADD FOREIGN KEY (`meetingId`) REFERENCES `ara_v2`.`meetings`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200506172949..20200512145722
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource mysql {
   provider = "mysql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
 enum Gender {
   MALE
@@ -42,8 +42,14 @@
   RESELLER
   MEMBER
 }
+enum MeetingType {
+  IN_PERSON
+  PHONE_CALL
+  VIDEO_CALL
+}
+
 model users {
   checkLocationOnLogin Boolean              @default(false)
   countryCode          String               @default("us")
   createdAt            DateTime             @default(now())
@@ -66,8 +72,10 @@
   username             String               @unique
   googleAccessToken    String?
   googleRefreshToken   String?
   emails               emails[]             @relation("userEmails")
+  incoming_emails      incoming_emails[]    @relation("userIncomingEmails")
+  meetings             meetings[]           @relation("userMeetings")
   access_tokens        access_tokens[]      @relation("userAccessTokens")
   approved_locations   approved_locations[] @relation("userApprovedLocations")
   backup_codes         backup_codes[]       @relation("userBackupCodes")
   identities           identities[]         @relation("userIdentities")
@@ -75,39 +83,93 @@
   sessions             sessions[]           @relation("userSessions")
 }
 model organizations {
-  autoJoinDomain      Boolean       @default(false)
-  createdAt           DateTime      @default(now())
-  forceTwoFactor      Boolean       @default(false)
-  id                  Int           @default(autoincrement()) @id
+  autoJoinDomain      Boolean           @default(false)
+  createdAt           DateTime          @default(now())
+  forceTwoFactor      Boolean           @default(false)
+  id                  Int               @default(autoincrement()) @id
   ipRestrictions      String?
   name                String
-  onlyAllowDomain     Boolean       @default(false)
-  profilePicture      String        @default("https://unavatar.now.sh/fallback.png")
+  onlyAllowDomain     Boolean           @default(false)
+  profilePicture      String            @default("https://unavatar.now.sh/fallback.png")
   stripeCustomerId    String?
-  updatedAt           DateTime      @updatedAt
-  username            String        @unique
-  api_keys            api_keys[]    @relation("organizationApiKeys")
-  domains             domains[]     @relation("organizationDomains")
-  memberships         memberships[] @relation("organizationMemberships")
-  webhooks            webhooks[]    @relation("organizationWebhooks")
-  assistantName       String        @default("Ara Isaacson (AI)")
-  assistantSignature  String        @default("Best,\n\n{{assistant_name}}")
-  schedulingDays      String        @default("1,2,3,4,5")
-  schedulingTimeStart String        @default("09:00:00")
-  schedulingTimeEnd   String        @default("05:00:00")
-  schedulingPadding   Int           @default(30)
+  updatedAt           DateTime          @updatedAt
+  username            String            @unique
+  api_keys            api_keys[]        @relation("organizationApiKeys")
+  domains             domains[]         @relation("organizationDomains")
+  memberships         memberships[]     @relation("organizationMemberships")
+  incoming_emails     incoming_emails[] @relation("organizationIncomingEmails")
+  meetings            meetings[]        @relation("organizationMeetings")
+  locations           locations[]       @relation("organizationLocations")
+  webhooks            webhooks[]        @relation("organizationWebhooks")
+  assistantName       String            @default("Ara Isaacson (AI)")
+  assistantSignature  String            @default("Best,\n\n{{assistant_name}}")
+  schedulingDays      String            @default("1,2,3,4,5")
+  schedulingTimeStart String            @default("09:00:00")
+  schedulingTimeEnd   String            @default("05:00:00")
+  schedulingPadding   Int               @default(15)
+  schedulingDuration  Int               @default(30)
   calendars           String?
-  customEmailEnabled  Boolean       @default(false)
+  customEmailEnabled  Boolean           @default(false)
   customEmailAddress  String?
   customEmailHost     String?
   customEmailPort     Int?
-  customEmailSecure   Boolean       @default(false)
+  customEmailSecure   Boolean           @default(false)
   customEmailUsername String?
   customEmailPassword String?
 }
+model locations {
+  id             Int               @default(autoincrement()) @id
+  type           MeetingType
+  data           Json?
+  value          String
+  meetings       meetings[]        @relation("meetingLocation")
+  organization   organizations     @relation("organizationLocations", fields: [organizationId], references: [id])
+  organizationId Int
+}
+
+model meetings {
+  id             Int               @default(autoincrement()) @id
+  proposedTimes  Json?
+  confirmedTime  Json?
+  meetingType    MeetingType
+  location       locations         @relation("meetingLocation", fields: [locationId], references: [id])
+  locationId     Int
+  user           users             @relation("userMeetings", fields: [userId], references: [id])
+  userId         Int
+  organization   organizations     @relation("organizationMeetings", fields: [organizationId], references: [id])
+  organizationId Int
+  emails         incoming_emails[] @relation("meetingIncomingEmails")
+}
+
+model incoming_emails {
+  id             Int           @default(autoincrement()) @id
+  objectId       String        @unique
+  logs           Json?
+  from           Json
+  to             Json
+  cc             Json
+  subject        String
+  emailDate      DateTime
+  messageId      String
+  inReplyTo      String?
+  createdAt      DateTime      @default(now())
+  updatedAt      DateTime      @updatedAt
+  user           users         @relation("userIncomingEmails", fields: [userId], references: [id])
+  userId         Int
+  organization   organizations @relation("organizationIncomingEmails", fields: [organizationId], references: [id])
+  organizationId Int
+  meeting        meetings      @relation("meetingIncomingEmails", fields: [meetingId], references: [id])
+  meetingId      Int
+
+  @@index([userId], name: "userId")
+  @@index([organizationId], name: "organizationId")
+  @@index([meetingId], name: "meetingId")
+  @@map("incoming-emails")
+}
+
 model emails {
   createdAt  DateTime @default(now())
   email      String
   id         Int      @default(autoincrement()) @id
```


